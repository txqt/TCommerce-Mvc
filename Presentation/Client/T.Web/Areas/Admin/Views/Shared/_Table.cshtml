@model DataTableViewModel

@{
    ViewData["Title"] = Model.TableTitle;
}

<h1>@Model.TableTitle</h1>

@if (Model.CreateUrl != null || Model.CreateUrl == string.Empty)
{
    <p>
        <a asp-action="Create">Create New</a>
    </p>
}

<table class="table" id="@Model.TableId">
    <thead>
        <tr>
            @foreach (var header in Model.Headers)
            {
                <th>@header</th>
            }
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>

<script>
    $(document).ready(function () {
        var tableId = '#@Model.TableId';
        var url = '@Model.GetDataUrl';
        var columns = @Html.Raw(Json.Serialize(Model.Columns));
        LoadTable(tableId, url, columns);
    });


    function LoadTable(tableId, url, columns) {
        var dataTableColumns = columns.map(function (column) {
            if (column.isEditable) {
                return {
                    data: null,
                    render: function (data, type, row) {
                        var editUrl = column.editUrl.replace('__id__', row.id);
                        return '<button class="btn btn-info" onclick="openPopup(\'' + editUrl + '\')">Edit</button>';
                    }
                };
            } else if (column.isDeletable) {
                return {
                    data: null,
                    render: function (data, type, row) {
                        var deleteUrl = column.deleteUrl.replace('__id__', row.id);
                        return '<button class="btn btn-danger deleteBtn" data-id="' + row.id + '" data-url="' + deleteUrl + '">Delete</button>';
                    }
                };
            } else if (column.isCheckBox) {
                return {
                    data: column.data,
                    render: function (data, type, row) {
                        if (type === "display") {
                            return '<input type="checkbox" disabled="disabled" ' + (data ? 'checked="checked"' : '') + '/>';
                        }
                        return data;
                    }
                };
            } else if (column.isPicture) {
                return {
                    data: column.data,
                    render: function (data, type, row) {
                        return '<img src="' + data + '" style="max-width: 200px;height: auto; "/>';
                    }
                };
            } else {
                return {
                    data: column.data
                };
            }
        });

        $(tableId).DataTable().destroy();
        $(tableId).DataTable({
            lengthMenu: [5, 10, 25, 50],
            pageLength: 5,
            ajax: {
                url: url,
                type: "GET",
                datatype: "json",
            },
            columns: dataTableColumns
        });

        $(tableId).on('click', '.deleteBtn', function () {
            var rowId = $(this).data('id');
            var deleteUrl = $(this).data('url');
            if (confirm('Are you sure you want to delete this item?')) {
                $.ajax({
                    url: deleteUrl,
                    type: 'POST',
                    success: function () {
                        $(tableId).DataTable().ajax.reload();
                    },
                    error: function () {
                        alert('An error occurred while deleting the item.');
                    }
                });
            }
        });
    }
</script>